<!doctype html>
<html>
<head>
    <title>CSGO Inventory Valuator</title>
</head>
<body>
    <h1>CSGO Inventory Valuator <span style="font-size : 10px;">by Szenmu</span></h1>
    <input type="text" id="tbxSteamID" placeholder="Steam64ID" value="76561198060787905"/>
    <button id="btnGo">Go!</button>
    <p id="area">loading</p>
    <p id="total"></p>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Class ID</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
    </table>
</body>
</html>

<script>

let inventory = [];

window.onload = function(){
    // url with CORS fix
    //let url = 'https://crossorigin.me/http://steamcommunity.com/inventory/76561198067565454/730/2?l=english&count=5000'; // My inventory
    let url = 'https://crossorigin.me/http://steamcommunity.com/inventory/76561198060787905/730/2?l=english&count=5000'; // James' Inventory

    let buttonCalculate = document.getElementById('btnGo');
    let steam64ID = document.getElementById('tbxSteamID');

    buttonCalculate.addEventListener('click',function(){
        url = 'https://crossorigin.me/http://steamcommunity.com/inventory/' + steam64ID.value + '/730/2?l=english&count=5000';
        alert(url);
    });
    
    
    var xhttp = new XMLHttpRequest();

    // async returned ok
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            document.getElementById('area').innerHTML = 'response back!';
            parseJSON(this.responseText);
            
        }
    };

    xhttp.open("GET", url, true);
    xhttp.send();
    
    // prompt user that request is sent
    document.getElementById('area').innerHTML = 'sent, waiting on response...';
};

function parseJSON(response){
    let tempData = JSON.parse(response);

    // total items in inventory
    let total = document.getElementById('total').innerHTML = 'Total items : ' + tempData.total_inventory_count;


    // Count number of each item
    let tempInventory = [];
    tempData.assets.forEach(element => {
        let contains = { found : false, index : 0 };
        for(let i = 0; i < tempInventory.length; i++){
            if(tempInventory[i].classid == element.classid){
                contains.found = true;
                contains.index = i;
                break;
            }
        }
        if(contains.found){
            tempInventory[contains.index].amount += 1;
        }
        else{
            tempInventory.push({ 
                classid : element.classid,
                amount : 1,
            });
        }
    });

    tempInventory.forEach(item => {
        for(let i = 0; i < tempData.descriptions.length; i++){
            if(item.classid == tempData.descriptions[i].classid){
                item.name = tempData.descriptions[i].market_hash_name; 
                break;
            }
        }
    });

    /*  Some items have different properties, eg 2 of the same skin but with different stickers, meaning they have
        the same name but have different classids. This sorts through the items that have the same name but different class ids */
    tempInventory = removeDuplicateNameEntries(tempInventory);
    /* now remove all the null rows so we have no issues when making the table */
    tempInventory = removeNullsFromArray(tempInventory);

    // fill table
    populateTable(tempInventory);

}

function populateTable(inventory){
    let tableBody = document.getElementById('tableBody');
    inventory.forEach(element => {
        tableBody.innerHTML += '<tr><td>' + element.name + '</td><td>' + element.classid + '</td><td>' + element.amount + '</td></tr>';
    });
}
function removeDuplicateNameEntries(array){
    for(let i = 0; i < array.length; i++){
        for(let j = 0; j < array.length; j++){
            if(array[i] != null && array[j] != null && array[i].name == array[j].name && i != j){
                array[i].amount += array[j].amount;
                array[j] = null;
            }
        }
    }
    return array;
}
function removeNullsFromArray(array){
    for(let i = 0; i < array.length; i++){
        if(array[i] == null){
            array.splice(i,1)
            i--;
        }
    }
    return array;
}




</script>